#clean environment
rm(list = ls())

#load libraries
library(tidyverse)
library(corrplot)
library(Hmisc)
library(ggpubr)
library(RColorBrewer)

#set working directory
setwd("C:/SANDEEP/Shmodel_US/montecarlo-svis")

#read files
param <- read.csv("SH_Parameters_withstate.csv") #model parameters for all coastal tracts under study
svi_in <- read.csv("SVCensusMOE.csv") #social vulnerability measures with margin of error for all tracts
colnames(svi_in)[2] <- "census_tract"

#set colors for the plots
my_color = brewer.pal(n = 3, name = "RdBu")
my_color = c(my_color[3], my_color[2], my_color[1])

#Remove column in svi you don't want
svi <- svi_in %>% select(-STATE)

#Select parameters to be used for correlation plot
param <- param %>% select(b1, b2, b3, duration, alpha_d, alpha_a, mew_a, census_tract)

#merge svi with parameters, with census_tract as common column
file <- merge(param, svi, by = "census_tract")
param_cor <- file %>% select(-census_tract) #remove census tract column

#remove any columns you don't want in correlation test
param_cor <- select(param_cor, -starts_with("M_")) #This removes columns containing margin of error

#Correlation plot
corfile_its <- rcorr(as.matrix(param_cor), type = "spearman")
r.values <- corfile_its$r[1:7, 8:23] #since we dont want redundancy in our correlation plot, 1:7 controls y axis variable, 8:23 controls x axis variables in correlation plot
p.values <- corfile_its$P[1:7, 8:23] 

oldp <- par(cex= 0.5) #this line is to make star inside corplot smaller
corrplot(r.values, method = "color", type = "full", diag = T, outline = T,
         tl.col = "black", addgrid.col = "grey",
         col = colorRampPalette(c(my_color[1], my_color[2], my_color[3]))(50),
         p.mat = p.values, sig.level = c(0.001, 0.01, 0.05), insig = 'label_sig', tl.cex = 1.5, cl.cex = 1.5)
